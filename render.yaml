services:
  - type: redis
    name: redis
    plan: free
    ipAllowList:
      - source: 0.0.0.0/0  

  - type: web
    name: ingest
    runtime: docker
    dockerfilePath: services/ingest/Dockerfile
    plan: free
    healthCheckPath: /health
    envVars:
      - key: REDIS_URL
        fromService: { type: redis, name: redis, property: connectionString }
      - key: LANGFUSE_HOST
        sync: false
      - key: LANGFUSE_PUBLIC_KEY
        sync: false
      - key: LANGFUSE_SECRET_KEY
        sync: false
      - key: LANGFUSE_TRACING_ENVIRONMENT
        value: render

  - type: web
    name: embeddings
    runtime: docker
    dockerfilePath: services/embeddings/Dockerfile
    plan: free
    healthCheckPath: /health
    envVars:
      - key: REDIS_URL
        fromService: { type: redis, name: redis, property: connectionString }
      - key: GEMINI_API_KEY
        sync: false
      - key: LANGFUSE_HOST
        sync: false
      - key: LANGFUSE_PUBLIC_KEY
        sync: false
      - key: LANGFUSE_SECRET_KEY
        sync: false
      - key: LANGFUSE_TRACING_ENVIRONMENT
        value: render
      - key: HF_HOME
        value: /app/data/.cache/huggingface
      - key: TRANSFORMERS_CACHE
        value: /app/data/.cache/huggingface/transformers

  - type: web
    name: retrieval
    runtime: docker
    dockerfilePath: services/retrieval/Dockerfile
    plan: starter         
    healthCheckPath: /health
    disk:
      name: faiss-data
      mountPath: /app/data
      sizeGB: 1
    envVars:
      - key: REDIS_URL
        fromService: { type: redis, name: redis, property: connectionString }
      - key: HF_HOME
        value: /app/data/.cache/huggingface
      - key: TRANSFORMERS_CACHE
        value: /app/data/.cache/huggingface/transformers
      - key: HF_HUB_CACHE
        value: /app/data/.cache/huggingface/hub
      - key: HF_DATASETS_CACHE
        value: /app/data/.cache/huggingface/datasets
      - key: SENTENCE_TRANSFORMERS_HOME
        value: /app/data/.cache/huggingface
      - key: FAISS_INDEX_PATH
        value: /app/data/faiss.index
      - key: DOC_MAP_PATH
        value: /app/data/doc_map.json
      - key: VECTOR_STORE
        value: FAISS
      - key: LANGFUSE_HOST
        sync: false
      - key: LANGFUSE_PUBLIC_KEY
        sync: false
      - key: LANGFUSE_SECRET_KEY
        sync: false
      - key: LANGFUSE_TRACING_ENVIRONMENT
        value: render

  - type: web
    name: llm-generate
    runtime: docker
    dockerfilePath: services/llm_generate/Dockerfile
    plan: free
    healthCheckPath: /health
    envVars:
      - key: REDIS_URL
        fromService: { type: redis, name: redis, property: connectionString }
      - key: GEMINI_API_KEY
        sync: false
      - key: LANGFUSE_HOST
        sync: false
      - key: LANGFUSE_PUBLIC_KEY
        sync: false
      - key: LANGFUSE_SECRET_KEY
        sync: false
      - key: LANGFUSE_TRACING_ENVIRONMENT
        value: render

  - type: web
    name: evaluation
    runtime: docker
    dockerfilePath: services/evaluation/Dockerfile
    plan: free
    healthCheckPath: /health
    envVars:
      - key: REDIS_URL
        fromService: { type: redis, name: redis, property: connectionString }
      - key: GEMINI_API_KEY
        sync: false
      - key: LANGFUSE_HOST
        sync: false
      - key: LANGFUSE_PUBLIC_KEY
        sync: false
      - key: LANGFUSE_SECRET_KEY
        sync: false
      - key: LANGFUSE_TRACING_ENVIRONMENT
        value: render

  - type: web
    name: api-gateway
    runtime: docker
    dockerfilePath: services/api_gateway/Dockerfile
    plan: free
    healthCheckPath: /health
    envVars:
      - key: REDIS_URL
        fromService: { type: redis, name: redis, property: connectionString }

      - key: INGEST_URL
        sync: false
      - key: RETRIEVAL_URL
        sync: false
      - key: EMBEDDINGS_URL
        sync: false
      - key: LLM_GENERATE_URL
        sync: false
      - key: EVALUATION_URL
        sync: false

      - key: STREAMLIT_APP_ORIGIN
        sync: false
      - key: LANGFUSE_HOST
        sync: false
      - key: LANGFUSE_PUBLIC_KEY
        sync: false
      - key: LANGFUSE_SECRET_KEY
        sync: false
      - key: LANGFUSE_TRACING_ENVIRONMENT
        value: render